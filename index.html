<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Paint By Numbers</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: 0;
            list-style: none;
            font-size: 16px;
            font-family: ‘Helvetica Neue’, Helvetica, Arial, sans-serif;
        }

        h1 {
            font-size: 2em;
            margin: 0.3em 0;
            width: 960px;
            margin: 0 auto;
        }

        #cv-container {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        #cv {
            margin: 0 auto;
            border: 1px solid #000;
        }

        input[type="text"], input[type="number"] {
            font-size: 0.9em;
            padding: 2px;
        }

        input[readonly] {
            background-color: #eee;
        }

        #container {
            width: 960px;
            margin: 0 auto;
        }

        #config {
            display: inline-block;
            width: 60%;
            margin-bottom: 100px;
        }



        #config ul li {
            line-height: 2.2em;
        }

            #config ul li > label {
                display: inline-block;
                width: 200px;
            }

            #config ul li .info {
                color: #666;
                font-size: 0.8em;
                line-height: 1.0em;
                margin-bottom: 0.4em;
            }

                #config ul li .info em {
                    font-size: 100%;
                }

            #config ul li input[type="number"], #config ul li input[type="color"] {
                width: 60px;
            }

            #config ul li input[type="text"] {
                width: 350px;
            }



        #history-container {
            display: inline-block;
            width: 39%;
            vertical-align:top;
        }

        #history-container label {
            display:inline-block;
            width:80px;
        }

        #history-container input[type="text"]{
            width:290px;
        }

        #history {

        }

        #history p {
            font-size:0.9em;
            margin-top:0.4em;
        }

        label.switch {
            font-size: 22px;
            display: inline-block;
            height: 1em !important;
            width: 2.7em !important;
            cursor: pointer;
            vertical-align: middle;
        }

            label.switch input[type="checkbox"] {
                display: none;
            }

            label.switch span {
                display: block;
                height: 100%;
                border: solid 1px #888;
                border-radius: 4px;
                background-color: red;
                position: relative;
                transition: background 0.1s linear;
            }

                label.switch span:before {
                    box-sizing: border-box;
                    content: "";
                    display: inline-block;
                    height: 100%;
                    width: 50%;
                    top: 0%;
                    left: 0%;
                    position: absolute;
                    background-color: white;
                    border-radius: 3px;
                    transition: left 0.1s ease;
                    border: solid 1px #ccc;
                }

            label.switch input:checked + span {
                background-color: green;
            }

                label.switch input:checked + span:before {
                    left: 50%;
                }

        .input-small {
            width: 150px !important;
        }



        body.obs #cv-container {
            text-align:left;
        }

        body.obs #cv {
            border:0;
        }

        body.obs h1 {
            display:none;
        }

        body.obs #container {
            display:none;
        }

    </style>
</head>
<body>
    <h1>Paint By Numbers</h1>
    <div id="cv-container">
        <canvas id="cv"></canvas>
    </div>
    <div id="container">
        <div id="config">
            <ul>
                <li>
                    <label>Canvas size:</label>
                    X: <input type="number" value="1280" id="txtCanvasX" min="1" max="3840" />
                    Y: <input type="number" value="720" id="txtCanvasY" min="1" max="2160" />
                </li>
                <li>
                    <label>Grid lines enabled:</label>
                    <label class="switch">
                        <input type="checkbox" id="cbShowGrid" checked />
                        <span></span>
                    </label>
                </li>
                <li>
                    <label>Grid size/color:</label>
                    <input type="number" value="4" id="txtGridSize" min="1" max="100" />
                    <input type="color" value="#b0b0b0" id="colGridColor" />
                </li>
                <li>
                    <label>Grid line underlap</label>
                    <label class="switch">
                        <input type="checkbox" id="cbGridUnderlap" checked />
                        <span></span>
                    </label>
                    <p class="info">If enabled, the drawn cells will overlap the grid lines, resulting in full coverage</p>
                </li>
                <li>
                    <label>Emphasis lines enabled:</label>
                    <label class="switch">
                        <input type="checkbox" id="cbShowGridEmphasis" checked />
                        <span></span>
                    </label>
                </li>
                <li>
                    <label>Emphasis frequency/color:</label>
                    <input type="number" value="10" id="txtEmphasisFrequency" />
                    <input type="color" value="#808080" id="colEmphasisColor" />
                    <p class="info">Optional color every <em>n</em> cells</p>
                </li>
                <li>
                    <label>Twitch channels:</label>
                    <input type="text" id="txtChannels" />
                    <p class="info">Comma-separated list of Twitch channels to connect to</p>
                </li>
                <li>
                    <label>Config name:</label>
                    <input type="text" id="txtName" />
                    <p class="info">If a name is set, then this config can be loaded with only the name</p>
                </li>
            </ul>
            <hr />
            <ul>
                <li>
                    <label>Grid size:</label>
                    <input type="text" id="txtGridSizeOutput" class="input-small" readonly />
                </li>
                <li>
                    <label>Effective canvas size:</label>
                    X: <input type="number" value="1280" id="txtEffectiveX" readonly />
                    Y: <input type="number" value="720" id="txtEffectiveY" readonly />
                </li>
                <li>
                    <label>Seed URL:</label>
                    <input type="text" id="txtSeedURL" readonly />
                </li>
                <li>
                    <label>Quick-load URL:</label>
                    <input type="text" id="txtQuickURL" readonly />
                </li>
            </ul>
        </div>

        <div id="history-container">
            <p><label>Chat:</label><input type="text" id="txtChat" /></p>
            <div id="history"></div>
        </div>
    </div>

    <script>

        //#region utility functions

        function Color(r, g, b) {
            this.R = r;
            this.G = g;
            this.B = b;
        }

        function Point(x, y) {
            this.X = x;
            this.Y = y;
        }

        function GetColorFromHex(hex) {
            hex = hex.replace('#', '');
            if (hex.length == 6)
                return new Color(
                    parseInt(hex.substring(0, 2), 16),
                    parseInt(hex.substring(2, 4), 16),
                    parseInt(hex.substring(4, 6), 16)
                );
            else if (hex.length == 3)
                return new Color(
                    parseInt(hex.substring(0, 1) + hex.substring(0, 1), 16),
                    parseInt(hex.substring(1, 2) + hex.substring(1, 2), 16),
                    parseInt(hex.substring(2, 3) + hex.substring(2, 3), 16)
                );

        }

        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        function Create2DArray(rows) {
            var arr = [];
            for (var i = 0; i < rows; i++)
                arr[i] = [];
            return arr;
        }

        //#endregion


        //#region global vars

        var colors = {
            "dust": "#b2996e",
            "tea": "#65ab7c",
            "cement": "#a5a391",
            "spruce": "#0a5f38",
            "booger": "#9bb53c",
            "bland": "#afa88b",
            "desert": "#ccad60",
            "purply": "#983fb2",
            "liliac": "#c48efd",
            "custard": "#fffd78",
            "manilla": "#fffa86",
            "bruise": "#7e4071",
            "azul": "#1d5dec",
            "darkgreen": "#054907",
            "lichen": "#8fb67b",
            "burple": "#6832e3",
            "butterscotch": "#fdb147",
            "toupe": "#c7ac7d",
            "squash": "#f2ab15",
            "cinnamon": "#ac4f06",
            "cocoa": "#875f42",
            "orangeish": "#fd8d49",
            "swamp": "#698339",
            "camo": "#7f8f4e",
            "fern": "#63a950",
            "sapphire": "#2138ab",
            "parchment": "#fefcaf",
            "straw": "#fcf679",
            "terracota": "#cb6843",
            "creme": "#ffffb6",
            "topaz": "#13bbaf",
            "wintergreen": "#20f986",
            "leather": "#ac7434",
            "hazel": "#8e7618",
            "canary": "#fdff63",
            "mushroom": "#ba9e88",
            "greenblue": "#23c48b",
            "carmine": "#9d0216",
            "grapefruit": "#fd5956",
            "ice": "#d6fffa",
            "algae": "#54ac68",
            "pinky": "#fc86aa",
            "darkblue": "#030764",
            "rosa": "#fe86a4",
            "lipstick": "#d5174e",
            "claret": "#680018",
            "dandelion": "#fedf08",
            "orangered": "#fe420f",
            "ruby": "#ca0147",
            "dark": "#1b2431",
            "putty": "#beae8a",
            "saffron": "#feb209",
            "twilight": "#4e518b",
            "bluegrey": "#85a3b2",
            "petrol": "#005f6a",
            "royal": "#0c1793",
            "butter": "#ffff81",
            "orangish": "#fc824a",
            "leaf": "#71aa34",
            "sunflower": "#ffc512",
            "velvet": "#750851",
            "carnation": "#fd798f",
            "wisteria": "#a87dc2",
            "pale": "#fff9d0",
            "greyblue": "#77a1b5",
            "purpley": "#8756e4",
            "diarrhea": "#9f8303",
            "viridian": "#1e9167",
            "bile": "#b5c306",
            "spearmint": "#1ef876",
            "yellowgreen": "#bbf90f",
            "heather": "#a484ac",
            "mango": "#ffa62b",
            "shamrock": "#01b44c",
            "bubblegum": "#ff6cb5",
            "lightgreen": "#76ff7b",
            "merlot": "#730039",
            "apple": "#6ecb3c",
            "heliotrope": "#d94ff5",
            "dusk": "#4e5481",
            "kiwi": "#9cef43",
            "seaweed": "#18d17b",
            "iris": "#6258c4",
            "perrywinkle": "#8f8ce7",
            "tealish": "#24bca8",
            "pear": "#cbf85f",
            "sandy": "#f1da7a",
            "greyish": "#a8a495",
            "banana": "#ffff7e",
            "tomato": "#ef4026",
            "sea": "#3c9992",
            "buff": "#fef69e",
            "fawn": "#cfaf7b",
            "amethyst": "#9b5fc0",
            "chestnut": "#742802",
            "pea": "#a4bf20",
            "stone": "#ada587",
            "earth": "#a2653e",
            "asparagus": "#77ab56",
            "blueberry": "#464196",
            "caramel": "#af6f09",
            "ocher": "#bf9b0c",
            "lightblue": "#7bc8f6",
            "golden": "#f5bf03",
            "gunmetal": "#536267",
            "cherry": "#cf0234",
            "midnight": "#03012d",
            "blood": "#770001",
            "berry": "#990f4b",
            "poo": "#8f7303",
            "snot": "#acbb0d",
            "drab": "#828344",
            "rouge": "#ab1239",
            "wheat": "#fbdd7e",
            "watermelon": "#fd4659",
            "mulberry": "#920a4e",
            "auburn": "#9a3001",
            "celadon": "#befdb7",
            "celery": "#c1fd95",
            "strawberry": "#fb2943",
            "copper": "#b66325",
            "ivory": "#ffffcb",
            "adobe": "#bd6c48",
            "barney": "#ac1db8",
            "ocre": "#c69c04",
            "maize": "#f4d054",
            "sandstone": "#c9ae74",
            "camel": "#c69f59",
            "marine": "#042e60",
            "sepia": "#985e2b",
            "coffee": "#a6814c",
            "mocha": "#9d7651",
            "ecru": "#feffca",
            "purpleish": "#98568d",
            "cranberry": "#9e003a",
            "melon": "#ff7855",
            "silver": "#c5c9c7",
            "amber": "#feb308",
            "vermillion": "#f4320c",
            "russet": "#a13905",
            "pine": "#2b5d34",
            "bluish": "#2976bb",
            "bronze": "#a87900",
            "shit": "#7f5f00",
            "dirt": "#8a6e45",
            "pistachio": "#c0fa8b",
            "yellowish": "#faee66",
            "bordeaux": "#7b002c",
            "ocean": "#017b92",
            "marigold": "#fcc006",
            "steel": "#738595",
            "blush": "#f29e8e",
            "lemon": "#fdff52",
            "cerise": "#de0c62",
            "apricot": "#ffb16d",
            "blurple": "#5539cc",
            "bluegreen": "#017a79",
            "forest": "#0b5509",
            "ultramarine": "#2000b1",
            "purplish": "#94568c",
            "reddish": "#c44240",
            "avocado": "#90b134",
            "umber": "#b26400",
            "poop": "#7f5e00",
            "eggshell": "#ffffd4",
            "denim": "#3b638c",
            "evergreen": "#05472a",
            "aubergine": "#3d0734",
            "mahogany": "#4a0100",
            "mud": "#735c12",
            "brownish": "#9c6d57",
            "clay": "#b66a50",
            "jade": "#1fa774",
            "emerald": "#01a049",
            "sky": "#82cafc",
            "orchid": "#c875c4",
            "raspberry": "#b00149",
            "tangerine": "#ff9408",
            "pumpkin": "#e17701",
            "charcoal": "#343837",
            "cornflower": "#6a79f7",
            "chocolate": "#3d1c02",
            "scarlet": "#be0119",
            "sienna": "#a9561e",
            "terracotta": "#ca6641",
            "grass": "#5cac2d",
            "moss": "#769958",
            "vomit": "#a2a415",
            "pinkish": "#d46a7e",
            "cobalt": "#1e488f",
            "wine": "#80013f",
            "azure": "#069af3",
            "grape": "#6c3461",
            "greenish": "#40a368",
            "coral": "#fc5a50",
            "cream": "#ffffc2",
            "brick": "#a03623",
            "sage": "#87ae73",
            "white": "#ffffff",
            "eggplant": "#380835",
            "puke": "#a5a502",
            "fuchsia": "#ed0dd9",
            "crimson": "#8c000f",
            "ochre": "#bf9005",
            "cerulean": "#0485d1",
            "rust": "#a83c09",
            "slate": "#516572",
            "goldenrod": "#fac205",
            "seafoam": "#80f9ad",
            "puce": "#a57e52",
            "sand": "#e2ca76",
            "mint": "#9ffeb0",
            "chartreuse": "#c1f80a",
            "taupe": "#b9a281",
            "khaki": "#aaa662",
            "burgundy": "#610023",
            "plum": "#580f41",
            "gold": "#dbb40c",
            "glod": "#ffdf00",
            "tasbot": "#7a5b07",
            "navy": "#01153e",
            "aquamarine": "#04d8b2",
            "rose": "#cf6275",
            "mustard": "#ceb301",
            "indigo": "#380282",
            "lime": "#aaff32",
            "periwinkle": "#8e82fe",
            "peach": "#ffb07c",
            "black": "#000000",
            "lilac": "#cea2fd",
            "beige": "#e6daa6",
            "salmon": "#ff796c",
            "olive": "#6e750e",
            "maroon": "#650021",
            "mauve": "#ae7181",
            "aqua": "#13eac9",
            "cyan": "#00ffff",
            "tan": "#d1b26f",
            "lavender": "#c79fef",
            "turquoise": "#06c2ac",
            "violet": "#9a0eea",
            "grey": "#929591",
            "yellow": "#ffff14",
            "magenta": "#c20078",
            "orange": "#f97306",
            "teal": "#029386",
            "red": "#e50000",
            "brown": "#653700",
            "pink": "#ff81c0",
            "blue": "#0343df",
            "green": "#15b01a",
            "purple": "#7e1e9c"

        };

        var
            canvas, //internal canvas object
            ctx, //canvas context
            imageData,
            effectiveWidth = 0,
            effectiveHeight = 0, //actual canvas dimensions calculated from grid settings

            settingsTimerId = -1, //timer variable for UI delay on update
            isLoading=false, //switch to ignore input change events while loading

            queryList = {}, //name-indexed list of query string parameters
            history = [], //history of draw orders given

            debug = true; //switch to log detailed info to console

        var config = {
            CanvasWidth: 1280,
            CanvasHeight: 720,
            GridEnabled: true,
            GridSize: 4,
            GridColor: '#b0b0b0',
            GridUnderlap: false,
            GridEmphasisEnabled: true,
            GridEmphasisFrequency: 10,
            GridEmphasisColor: '#808080',
            TwitchChannels: [],
            Name: 'default'
        };

        //#endregion


        //#region websocket

        function Connect() {

            var ws = new WebSocket('wss://irc-ws.chat.twitch.tv');

            ws.onopen = function open(e) {
                if (debug)
                    console.log('Websocket opening: ', e);
                this.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                this.send('NICK justinfan' + Math.floor(Math.random() * 999999));
                for (var i = 0; i < config.TwitchChannels.length; i++) {
                    this.send('JOIN #' + config.TwitchChannels[i]);
                }
            }

            //show raw data
            ws.onmessage = function (data) {
                if (debug)
                    console.log(data.data);

                if (data.data.indexOf('PRIVMSG') > -1) {
                    var parts = data.data.split('PRIVMSG');
                    var preparts = parts[0].split(';');
                    var user = preparts[preparts.length - 1].split(':')[1].split('!')[0];

                    var cIdx = parts[1].indexOf(':');
                    var msg = parts[1].substring(cIdx+1);


                    ParseMessage(user, msg);

                    /*
                    var o = GetChatObject(data.data);

                    var userParts = o["user-type"].split(':');
                    var ircUser = userParts[1].split('!')[0];
                    userParts.shift();
                    userParts.shift();
                    var ircMsg = userParts.join(':');
                    */
                    //ParseInput(ircMsg);
                }
                else if (data.data.indexOf('PING') == 0) {
                    ws.send('PONG ' + data.data.split(':')[1]);
                }
            }

            ws.onerror = function (e) {
                if (debug)
                    console.log('Websocket error: ', e);
            }

            ws.onclose = function (e) {
                if (debug)
                    console.log('Websocket closed: ', e);
                setTimeout(function () {
                    Connect();
                }, 1000);
            }
        }

/*
        @badges=moderator/1,subscriber/0,bits/5000;
        color=#FF4500;
        display-name=MediaMagnet;
        emotes=;
        id=98a76159-e2f6-4080-bb5e-910cd54a6467;
        mod=1;
        room-id=70067886;
        sent-ts=1509252055763;
        subscriber=1;tmi-sent-ts=1509252067701;
        turbo=0;user-id=111485954;
        user-type=mod:mediamagnet!mediamagnet@mediamagnet.tmi.twitch.tv PRIVMSG #dwangoac :oh nice
*/

        function GetChatObject(str) {
            var ret = {};
            var mainParts = str.split('PRIVMSG');
            var parts = mainParts[0].split(';');

            for (var i = 0; i < parts.length; i++) {
                var subparts = parts[i].split('=');
                var k = subparts[0].trim();
                subparts.shift();
                ret[k] = subparts.join('=').trim();
            }
            return ret;
        }

        //#endregion


        //#region init

        (function () {

            canvas = document.getElementById('cv');

            //bind UI update events
            txtCanvasX.oninput = UpdateSettingsTrigger;
            txtCanvasY.oninput = UpdateSettingsTrigger;
            cbShowGrid.onchange = UpdateSettingsTrigger;
            txtGridSize.oninput = UpdateSettingsTrigger;
            colGridColor.onchange = UpdateSettingsTrigger;
            cbGridUnderlap.onchange = UpdateSettingsTrigger;
            cbShowGridEmphasis.onchange = UpdateSettingsTrigger;
            txtEmphasisFrequency.oninput = UpdateSettingsTrigger;
            colEmphasisColor.onchange = UpdateSettingsTrigger;
            txtChannels.oninput = UpdateSettingsTrigger;
            txtName.oninput = UpdateSettingsTrigger;
            txtChat.onkeydown = ManualChat;

            //create queryList array
            if (window.location.search) {
                var query = window.location.search;
                var queryParts = query.substring(1).split('&');
                for (var i = 0; i < queryParts.length; i++) {
                    var parts = queryParts[i].split('=');
                    queryList[parts[0].trim()] = parts[1].trim();

                }
            }

            if (window.obsstudio || queryList["mode"]=="obs") {
                document.getElementsByTagName('body')[0].classList.add('obs');
            }


            //load if possible
            if (queryList["config"]) {
                if (localStorage.getItem(queryList["config"]) != null) {
                    LoadSettings(queryList["config"]);
                }
                else {
                    //config specified, but doesn't exist
                    if (queryList["seed"]) {
                        config = JSON.parse(atob(queryList["seed"]));
                        SaveSettings();
                        LoadSettings('pbn-' + config.Name);
                    }
                    else {
                        //specified config doesn't exist, no seed, init defaults
                        UpdateSettings();
                    }
                }
            }
            else {
                if (localStorage.getItem('pbn-default') != null) {
                    LoadSettings('pbn-default');
                }
                else if (queryList["seed"]) {
                    //no config, seed, load from seed
                    config = JSON.parse(atob(queryList["seed"]));
                    SaveSettings();
                    LoadSettings('pbn-' + config.Name);
                }
                else {
                    //no config, no seed, init defaults
                    UpdateSettings();
                }
            }

            if (config.TwitchChannels.length > 0) {
                Connect();
            }
        })();

        //#endregion


        //#region save & load stuff

        function UpdateSettingsTrigger() {
            if (!isLoading) {
                clearTimeout(settingsTimerId);
                settingsTimerId = setTimeout(UpdateSettings, 500);
            }
        }

        function UpdateSettings() {
            
            config.CanvasWidth = parseInt(txtCanvasX.value, 10);
            config.CanvasHeight = parseInt(txtCanvasY.value, 10);
            config.GridEnabled = cbShowGrid.checked;
            config.GridSize = parseInt(txtGridSize.value, 10);
            config.GridColor = colGridColor.value;
            config.GridUnderlap = cbGridUnderlap.checked;
            config.GridEmphasisEnabled = cbShowGridEmphasis.checked;
            config.GridEmphasisFrequency = parseInt(txtEmphasisFrequency.value, 10);
            config.GridEmphasisColor = colEmphasisColor.value;
            if (txtChannels.value.trim() != '')
                config.TwitchChannels = txtChannels.value.split(',').map(function (x) { return x.trim(); });
            else
                config.TwitchChannels = [];

            if (txtName.value.trim() != '')
                config.Name = txtName.value.trim();
            else
                config.Name = 'default';

            UpdateURLs();

            SaveSettings();

            DrawGrid();
        }

        function SaveSettings() {
            localStorage.setItem('pbn-' + config.Name, JSON.stringify(config));
            if (debug)
                console.log('settings saved');
        }

        function LoadSettings(configName) {
            isLoading = true;

            //TODO
            config = JSON.parse(localStorage.getItem(configName));
            if (debug)
                console.log(config);

            txtCanvasX.value = config.CanvasWidth;
            txtCanvasY.value = config.CanvasHeight;
            cbShowGrid.checked = config.GridEnabled;
            txtGridSize.value = config.GridSize;
            colGridColor.value = config.GridColor;
            cbGridUnderlap.checked = config.GridUnderlap;
            cbShowGridEmphasis.checked = config.GridEmphasisEnabled;
            txtEmphasisFrequency.value = config.GridEmphasisFrequency;
            colEmphasisColor.value = config.GridEmphasisColor;
            txtChannels.value = config.TwitchChannels.join(', ');
            txtName.value = config.Name;

            UpdateURLs();

            isLoading = false;
            DrawGrid();
        }

        function UpdateURLs() {
            txtQuickURL.value = window.location.href.replace(window.location.search, '') + '?config=pbn-' + config.Name;
            txtSeedURL.value = window.location.href.replace(window.location.search, '') + '?config=pbn-' + config.Name + '&seed=' + btoa(JSON.stringify(config));
        }

        //#endregion


        //#region drawing code

        function DrawGrid() {
            var gridDimX, gridDimY;

            if (config.GridEnabled && !config.GridUnderlap) {
                gridDimX = Math.floor((config.CanvasWidth + 1) / (config.GridSize+1));
                effectiveWidth = (gridDimX * (config.GridSize + 1)) - 1;

                gridDimY = Math.floor((config.CanvasHeight + 1) / (config.GridSize+1));
                effectiveHeight = (gridDimY * (config.GridSize + 1)) - 1;
            }
            else { //underlap and no grid at all have the same grid size calculation
                gridDimX = Math.floor(config.CanvasWidth / config.GridSize);
                effectiveWidth = gridDimX * config.GridSize;

                gridDimY = Math.floor(config.CanvasHeight / config.GridSize);
                effectiveHeight = gridDimY * config.GridSize;
            }

            canvas.width = effectiveWidth;
            canvas.height = effectiveHeight;

            txtEffectiveX.value = effectiveWidth;
            txtEffectiveY.value = effectiveHeight;

            txtGridSizeOutput.value = (gridDimX) + 'x' + (gridDimY);

            ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (config.GridEnabled) {
                var gridDrawSize = config.GridSize + (config.GridUnderlap ? 0 : 1);
                ctx.strokeStyle = config.GridColor;
                ctx.lineWidth = 1;

                for (var x = 1; x < gridDimX; x++) {
                    ctx.beginPath();
                    ctx.moveTo((x * gridDrawSize)-0.5, 0);
                    ctx.lineTo((x * gridDrawSize)-0.5, canvas.height);
                    ctx.stroke();
                }
                for (var y = 1; y < gridDimY; y++) {
                    ctx.beginPath();
                    ctx.moveTo(0, (y * gridDrawSize) - 0.5);
                    ctx.lineTo(canvas.width, (y * gridDrawSize) - 0.5);
                    ctx.stroke();
                }

                if (config.GridEmphasisEnabled) {
                    ctx.strokeStyle = config.GridEmphasisColor;

                    for (var x = 1; x < (gridDimX / config.GridEmphasisFrequency); x++) {
                        ctx.beginPath();
                        ctx.moveTo((x * config.GridEmphasisFrequency * gridDrawSize) - 0.5, 0);
                        ctx.lineTo((x * config.GridEmphasisFrequency* gridDrawSize) - 0.5, canvas.height);
                        ctx.stroke();
                    }

                    for (var y = 1; y < (gridDimY / config.GridEmphasisFrequency); y++) {
                        ctx.beginPath();
                        ctx.moveTo(0, (y * config.GridEmphasisFrequency * gridDrawSize) - 0.5);
                        ctx.lineTo(canvas.width, (y * config.GridEmphasisFrequency *gridDrawSize) - 0.5);
                        ctx.stroke();
                    }
                }
            }
            imageData = ctx.createImageData(canvas.width, canvas.height);

            //ctx.fillStyle='color';
            //ctx.fillRect(x,y,w,h);

        }


        //imageData drawing of a square, TODO: test if faster than ctx.fillRect()
        function DrawCellData(x, y, c) {
            for (var x2 = 0; x2 < config.GridSize; x2++) {
                for (var y2 = 0; y2 < config.GridSize; y2++) {

                    var index =
                        (((x * config.GridSize) + x2) +
                            ((y * config.GridSize) + y2) *
                            canvas.width) * 4;
                    imageData.data[index++] = c.R;
                    imageData.data[index++] = c.G;
                    imageData.data[index++] = c.B;
                    imageData.data[index] = 255;
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function DrawCell(x, y, c) {
            ctx.fillStyle = c;
            var gridDrawSize = config.GridSize + (config.GridUnderlap ? 0 : 1);
            ctx.fillRect(x * gridDrawSize, y * gridDrawSize, config.GridSize, config.GridSize);
        }


        //#endregion


        //#region chat input handling

        function ManualChat(e) {
            if (e.keyCode == 13) {
                ParseMessage('manual', txtChat.value);
                txtChat.value = '';
            }
        }

        function ParseMessage(user, text) {
            text = text.trim().toLowerCase();
            var c, coords;

            if (text.indexOf('rgb') == 0) {
                var parts = text.replace('rgb(','').split(')');
                var colParts = parts[0].split(',');
                c = rgbToHex(parseInt(colParts[0], 10), parseInt(colParts[1], 10), parseInt(colParts[2], 10));
                coords = parts[1];
            }
            else if (text.indexOf('#') == 0) {
                var parts = text.split(' ');
                if (parts[0].length == 7)
                    c = parts[0];
                else if (parts[0].length == 4)
                    c = '#' + parts[0].substring(1, 2) + parts[0].substring(1, 2) + parts[0].substring(2, 3) + parts[0].substring(2, 3) + parts[0].substring(3, 4) + parts[0].substring(3, 4);
                coords = parts[1];

            }
            else {
                var parts = text.split(' ');
                if (colors[parts[0]] != undefined) {
                    c = colors[parts[0]];
                    coords = parts[1];
                }
            }

            if (c != undefined) {
                var coordParts = coords.split(',');

                if (coordParts.length == 2) {
                    DrawCell(parseInt(coordParts[0], 10) - 1, parseInt(coordParts[1], 10) - 1, c);

                    var str = '<p>' + user + ": " + c + " " + coordParts[0] + "," + coordParts[1] + '</p>';
                    document.getElementById('history').insertAdjacentHTML('afterbegin', str);
                }
            }


        }


        //#endregion

    </script>
</body>
</html>